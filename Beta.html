<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Apprendre « Il faut être toujours ivre » — VR + PNL</title>
  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- A-Frame for VR/WebXR -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
  <style>
    html { font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial, 'Noto Sans', 'Apple Color Emoji', 'Segoe UI Emoji'; }
    .glass { background: rgba(255,255,255,0.6); backdrop-filter: blur(8px); }
    .dark .glass { background: rgba(17,24,39,0.5); }
    .kbd { border: 1px solid rgb(229 231 235); border-bottom-width: 3px; padding: 0.125rem 0.375rem; border-radius: 0.375rem; font-weight: 600; font-size: 0.75rem; }
    .dark .kbd { border-color: rgb(55 65 81); }
    .btn { @apply px-3 py-2 rounded-2xl shadow hover:shadow-lg transition; }
  </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-indigo-50 dark:from-slate-900 dark:to-indigo-950 text-slate-900 dark:text-slate-100 min-h-screen">
  <!-- Header -->
  <header class="sticky top-0 z-30 backdrop-blur bg-white/50 dark:bg-slate-900/50 border-b border-white/20 dark:border-slate-800/50">
    <div class="max-w-5xl mx-auto px-4 py-3 flex items-center justify-between">
      <h1 class="text-xl sm:text-2xl font-extrabold tracking-tight">« Il faut être toujours ivre » — Baudelaire</h1>
      <div class="flex items-center gap-2">
        <button id="darkToggle" class="btn bg-slate-900 text-white dark:bg-white dark:text-slate-900">🌙 / ☀️</button>
        <button id="fsToggle" class="btn bg-indigo-600 text-white">⛶ Plein écran</button>
        <button id="vrJump" class="btn bg-emerald-600 text-white">🕶️ Mode VR</button>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="max-w-5xl mx-auto px-4 py-6 grid lg:grid-cols-3 gap-6">
    <!-- Left: Méthode PNL -->
    <section class="lg:col-span-1 glass rounded-2xl p-5 shadow">
      <h2 class="text-lg font-bold mb-3">Méthode PNL — ancrage & visualisation</h2>
      <ol class="space-y-3 text-sm leading-relaxed">
        <li><span class="font-semibold">Ancrage sensoriel.</span> Choisis un <em>geste simple</em> (ex: pincer le pouce et l'index). Chaque fois que tu réussis un exercice, fais ce geste. Tu ancreras la réussite au geste.</li>
        <li><span class="font-semibold">Association VAKOG.</span> Ferme les yeux 10 s et imagine <em>voir</em> les mots défiler, <em>entendre</em> ta voix, <em>ressentir</em> la cadence, <em>odorat/goût</em> liés au vin/poésie/vertu. Puis lis à voix haute.</li>
        <li><span class="font-semibold">Chunking.</span> Le poème est découpé en <span class="font-semibold">6 blocs</span>. Maîtrise 1 bloc → teste-toi → passe au suivant.</li>
        <li><span class="font-semibold">Répétition espacée (SRS).</span> Chaque bloc a des révisions J+0, J+1, J+3, J+7. Le planning s’adapte selon tes réponses (LocalStorage).</li>
        <li><span class="font-semibold">Cloze actif.</span> Cache des mots-clés et restitue-les. Plus l’omission est grande, plus la mémoire est profonde.</li>
        <li><span class="font-semibold">Respiration rythmée.</span> Inspire 4 — Retien 4 — Expire 6 avant chaque session. Réduit le bruit mental.</li>
      </ol>
      <div class="mt-4 flex gap-2">
        <button id="resetProgress" class="btn bg-rose-600 text-white">Réinitialiser</button>
        <button id="exportProgress" class="btn bg-slate-200 dark:bg-slate-800">Exporter</button>
      </div>
      <p class="text-xs opacity-70 mt-2">Astuce : <span class="kbd">Espace</span> pour lancer/arrêter la lecture audio.</p>
    </section>

    <!-- Middle: Poème & Outils -->
    <section class="lg:col-span-2 space-y-6">
      <!-- Audio & paramètres -->
      <div class="glass rounded-2xl p-5 shadow flex flex-col sm:flex-row gap-4 sm:items-end">
        <div class="flex-1">
          <label class="block text-sm font-semibold">Voix (TTS navigateur)</label>
          <select id="voiceSelect" class="w-full mt-1 rounded-xl px-3 py-2 bg-white/70 dark:bg-slate-900/70 border border-slate-200 dark:border-slate-700"></select>
        </div>
        <div>
          <label class="block text-sm font-semibold">Vitesse</label>
          <input id="rate" type="range" min="0.6" max="1.4" step="0.05" value="1" class="w-48">
        </div>
        <div class="flex gap-2">
          <button id="playAll" class="btn bg-indigo-600 text-white">▶️ Lire le poème</button>
          <button id="stopAll" class="btn bg-slate-200 dark:bg-slate-800">⏹️ Stop</button>
        </div>
      </div>

      <!-- Blocs (chunking) -->
      <div id="chunks" class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- Template generated by JS -->
      </div>

      <!-- Cloze Trainer -->
      <div class="glass rounded-2xl p-5 shadow">
        <h3 class="text-lg font-bold mb-2">Entraîneur Cloze (mots masqués)</h3>
        <p class="text-sm opacity-80">Choisis le niveau d’omission, puis teste ta restitution. Affiche la solution pour auto-corriger et reviens au texte intégral.</p>
        <div class="flex flex-wrap gap-3 mt-3 items-center">
          <label>Omission : <input id="clozePercent" type="range" min="0" max="70" value="25" step="5"></label>
          <button id="makeCloze" class="btn bg-emerald-600 text-white">Générer Cloze</button>
          <button id="showSolution" class="btn bg-slate-200 dark:bg-slate-800">Afficher solution</button>
        </div>
        <div id="clozeContainer" class="mt-4 whitespace-pre-wrap leading-8"></div>
      </div>

      <!-- Planificateur SRS -->
      <div class="glass rounded-2xl p-5 shadow">
        <h3 class="text-lg font-bold mb-2">Répétition espacée</h3>
        <p class="text-sm opacity-80">Marque chaque bloc « Réussi » (5 — parfait) à « Difficile » (1). Le système programme automatiquement la prochaine révision. Astuce : fais ton <em>ancrage</em> juste après un « Réussi ».</p>
        <div id="srsList" class="grid grid-cols-1 md:grid-cols-2 gap-3"></div>
      </div>

    </section>
  </main>

  <!-- A-Frame VR Scene -->
  <a-scene embedded background="color: #0f172a" vr-mode-ui="enabled: true">
    <!-- Sky gradient approx -->
    <a-sky color="#0f172a"></a-sky>
    <!-- Camera -->
    <a-entity position="0 1.6 0">
      <a-camera wasd-controls-enabled="false"></a-camera>
    </a-entity>
    <!-- Panels for each chunk -->
    <a-entity id="vrRoot"></a-entity>
  </a-scene>

  <!-- Footer -->
  <footer class="max-w-5xl mx-auto px-4 pb-10 text-xs opacity-70">
    <hr class="my-6 border-slate-200 dark:border-slate-800" />
    <p>Texte : Charles Baudelaire (domaine public). Page : étude multimodale (VR + PNL) — fonctionne sur les navigateurs compatibles WebXR/A‑Frame.</p>
  </footer>

  <script>
  // —————————————————————————————————————————————
  // Données du poème (découpage en 6 blocs)
  // —————————————————————————————————————————————
  const POEM_TITLE = 'Il faut être toujours ivre';
  const BLOCKS = [
    `Il faut être toujours ivre. Tout est là : c’est l’unique question.`,
    `Pour ne pas sentir l’horrible fardeau du Temps qui brise vos épaules et vous penche vers la terre, il faut vous enivrer sans trêve.`,
    `Mais de quoi ? De vin, de poésie ou de vertu, à votre guise. Mais enivrez‑vous.`,
    `Et si quelquefois, sur les marches d’un palais, sur l’herbe verte d’un fossé, dans la solitude morne de votre chambre, vous vous réveillez, l’ivresse déjà diminuée ou disparue,`,
    `demandez au vent, à la vague, à l’étoile, à l’oiseau, à l’horloge, à tout ce qui fuit, à tout ce qui gémit, à tout ce qui roule, à tout ce qui chante, à tout ce qui parle, demandez quelle heure il est ;`,
    `et le vent, la vague, l’étoile, l’oiseau, l’horloge vous répondront : — Il est l’heure de s’enivrer ! Pour n’être pas les esclaves martyrisés du Temps, enivrez‑vous ; enivrez‑vous sans cesse ! De vin, de poésie ou de vertu, à votre guise.`
  ];

  // —————————————————————————————————————————————
  // Dark mode & Fullscreen
  // —————————————————————————————————————————————
  const darkToggle = document.getElementById('darkToggle');
  const fsToggle = document.getElementById('fsToggle');
  const vrJump = document.getElementById('vrJump');
  darkToggle.addEventListener('click', () => document.documentElement.classList.toggle('dark'));
  fsToggle.addEventListener('click', () => {
    if (!document.fullscreenElement) document.documentElement.requestFullscreen?.();
    else document.exitFullscreen?.();
  });
  vrJump.addEventListener('click', () => {
    const scene = document.querySelector('a-scene');
    if (scene && scene.enterVR) scene.enterVR();
  });

  // —————————————————————————————————————————————
  // TTS (Web Speech API)
  // —————————————————————————————————————————————
  const voiceSelect = document.getElementById('voiceSelect');
  const rate = document.getElementById('rate');
  const playAll = document.getElementById('playAll');
  const stopAll = document.getElementById('stopAll');
  let VOICES = [];
  function loadVoices(){
    VOICES = window.speechSynthesis.getVoices().filter(v => v.lang.toLowerCase().startsWith('fr'));
    voiceSelect.innerHTML = VOICES.map((v,i)=>`<option value="${i}">${v.name} (${v.lang})</option>`).join('');
  }
  loadVoices();
  window.speechSynthesis.onvoiceschanged = loadVoices;

  function speak(text){
    const u = new SpeechSynthesisUtterance(text);
    const idx = parseInt(voiceSelect.value || '0', 10) || 0;
    if (VOICES[idx]) u.voice = VOICES[idx];
    u.rate = parseFloat(rate.value || '1');
    window.speechSynthesis.speak(u);
    return u;
  }
  function stopSpeak(){ window.speechSynthesis.cancel(); }

  playAll.addEventListener('click', () => {
    stopSpeak();
    // Enchaîner les blocs
    let i = 0;
    function next(){
      if (i >= BLOCKS.length) return;
      const u = speak(BLOCKS[i]);
      i++;
      u.onend = next;
    }
    next();
  });
  stopAll.addEventListener('click', stopSpeak);
  // Espace = Play/Stop
  window.addEventListener('keydown', (e)=>{ if (e.code==='Space'){ e.preventDefault(); if (speechSynthesis.speaking) stopSpeak(); else playAll.click(); }});

  // —————————————————————————————————————————————
  // CHUNKS UI + VR panels
  // —————————————————————————————————————————————
  const chunksDiv = document.getElementById('chunks');
  const vrRoot = document.getElementById('vrRoot');

  function createChunkCard(i, text){
    const id = `chunk-${i}`;
    const el = document.createElement('div');
    el.className = 'rounded-2xl glass p-4 shadow flex flex-col gap-3';
    el.innerHTML = `
      <div class="flex items-center justify-between">
        <h4 class="font-semibold">Bloc ${i+1}</h4>
        <div class="text-xs opacity-70" id="srs-next-${i}"></div>
      </div>
      <p id="${id}" class="leading-7">${text}</p>
      <div class="flex gap-2 flex-wrap">
        <button class="btn bg-indigo-600 text-white" data-act="tts">▶️ Lire</button>
        <button class="btn bg-slate-200 dark:bg-slate-800" data-act="hide">🙈 Masquer mots clés</button>
        <button class="btn bg-slate-200 dark:bg-slate-800" data-act="show">👁️ Révéler</button>
        <button class="btn bg-emerald-600 text-white" data-act="copy">📋 Copier</button>
      </div>
    `;
    // handlers
    el.querySelector('[data-act="tts"]').addEventListener('click', ()=> speak(text));
    el.querySelector('[data-act="hide"]').addEventListener('click', ()=> hideKeywords(id, 30));
    el.querySelector('[data-act="show"]').addEventListener('click', ()=> showText(id, text));
    el.querySelector('[data-act="copy"]').addEventListener('click', async ()=>{
      await navigator.clipboard.writeText(text); el.querySelector('[data-act="copy"]').textContent = '✅ Copié'; setTimeout(()=> el.querySelector('[data-act="copy"]').textContent = '📋 Copier', 1200);
    });
    return el;
  }

  // Build cards and VR panels
  BLOCKS.forEach((t,i)=>{
    chunksDiv.appendChild(createChunkCard(i,t));
    // VR panel entity
    const y = 1.6; const radius = 3.2; const angle = (-30 + i*12) * Math.PI/180; // arc in front
    const x = Math.sin(angle)*radius; const z = -Math.cos(angle)*radius;
    const panel = document.createElement('a-entity');
    panel.setAttribute('position', `${x} ${y} ${z}`);
    panel.setAttribute('rotation', `0 ${-angle*180/Math.PI} 0`);
    panel.innerHTML = `
      <a-plane width="2.2" height="1.2" color="#111827" opacity="0.85" material="side:double" class="vr-panel"></a-plane>
      <a-entity text="value: Bloc ${i+1}: ${t.replace(/"/g,'&quot;')}; color: #e5e7eb; width: 2.2; wrapCount: 30"></a-entity>
    `;
    vrRoot.appendChild(panel);
  });

  function hideKeywords(id, percent=30){
    const el = document.getElementById(id);
    const original = BLOCKS[parseInt(id.split('-')[1],10)];
    const words = original.split(/(\s+)/);
    const totalWords = words.filter(w=>/\w/.test(w)).length;
    let toHide = Math.floor(totalWords * (percent/100));
    for(let i=0;i<words.length;i++){
      if(!/\w/.test(words[i])) continue;
      if (toHide<=0) break;
      if (Math.random() < 0.5){
        words[i] = `<span class="bg-slate-300/60 dark:bg-slate-700/60 rounded px-1 select-none">    </span>`; toHide--;
      }
    }
    el.innerHTML = words.join('');
  }
  function showText(id, text){ document.getElementById(id).textContent = text; }

  // —————————————————————————————————————————————
  // CLOZE TRAINER
  // —————————————————————————————————————————————
  const clozePercent = document.getElementById('clozePercent');
  const clozeContainer = document.getElementById('clozeContainer');
  document.getElementById('makeCloze').addEventListener('click', ()=>{
    const percent = parseInt(clozePercent.value,10);
    const base = BLOCKS.join(' ');
    const tokens = base.split(/(\s+|[,.!?;:—–-])/);
    const wordIdx = tokens.map((t,i)=>(/^[A-Za-zÀ-ÖØ-öø-ÿ']+$/.test(t) ? i : -1)).filter(i=>i>=0);
    const hideCount = Math.floor(wordIdx.length * percent/100);
    const toHide = new Set();
    while(toHide.size < hideCount){ toHide.add(wordIdx[Math.floor(Math.random()*wordIdx.length)]); }
    const out = tokens.map((t,i)=> toHide.has(i) ? `<span class='bg-indigo-200/60 dark:bg-indigo-800/60 rounded px-1'>____</span>` : t).join('');
    clozeContainer.innerHTML = out;
  });
  document.getElementById('showSolution').addEventListener('click', ()=>{
    clozeContainer.textContent = BLOCKS.join(' ');
  });

  // —————————————————————————————————————————————
  // SRS (spaced repetition) ultra simple
  // —————————————————————————————————————————————
  const srsList = document.getElementById('srsList');
  const SRS_KEY = 'ivre_baudelaire_srs_v1';
  const NOW = () => new Date();
  function loadSRS(){
    const raw = localStorage.getItem(SRS_KEY);
    if (!raw) return BLOCKS.map((_,i)=>({ id:i, due:new Date().toISOString(), easiness:2.5, interval:0 }));
    try { return JSON.parse(raw).map(x=>({ ...x, due: new Date(x.due).toISOString() })); } catch { return BLOCKS.map((_,i)=>({ id:i, due:new Date().toISOString(), easiness:2.5, interval:0 })); }
  }
  let SRS = loadSRS();

  function saveSRS(){ localStorage.setItem(SRS_KEY, JSON.stringify(SRS)); }
  function fmt(d){ const dt = new Date(d); return dt.toLocaleString([], { dateStyle:'medium', timeStyle:'short' }); }
  function schedule(id, quality){
    // SM-2 simplifiée
    const card = SRS.find(c=>c.id===id);
    const q = Math.max(0, Math.min(5, quality));
    if (q < 3){ card.interval = 1; }
    else {
      if (card.interval === 0) card.interval = 1;
      else if (card.interval === 1) card.interval = 3;
      else card.interval = Math.round(card.interval * card.easiness);
      card.easiness = Math.max(1.3, card.easiness + (0.1 - (5-q) * (0.08 + (5-q)*0.02)));
    }
    const next = new Date(NOW()); next.setDate(next.getDate() + card.interval);
    card.due = next.toISOString();
    saveSRS();
    renderSRS();
  }
  function renderSRS(){
    srsList.innerHTML = '';
    SRS.forEach((c,i)=>{
      const wrap = document.createElement('div');
      wrap.className = 'rounded-2xl glass p-3 flex items-center justify-between gap-2';
      wrap.innerHTML = `
        <div>
          <div class='text-sm font-semibold'>Bloc ${c.id+1}</div>
          <div class='text-xs opacity-70'>Prochaine révision : <span id='due-${c.id}'>${fmt(c.due)}</span></div>
        </div>
        <div class='flex gap-1'>
          ${[1,2,3,4,5].map(n=>`<button class='btn ${n>=4?'bg-emerald-600 text-white':'bg-slate-200 dark:bg-slate-800'}' data-q='${n}' data-id='${c.id}'>${n}</button>`).join('')}
        </div>
      `;
      wrap.querySelectorAll('button').forEach(b=> b.addEventListener('click', ()=> schedule(parseInt(b.dataset.id,10), parseInt(b.dataset.q,10))));
      srsList.appendChild(wrap);
      // Update small badges on chunk cards
      const badge = document.getElementById(`srs-next-${c.id}`);
      if (badge) badge.textContent = '⏰ ' + fmt(c.due);
    });
  }
  renderSRS();

  // Export / Reset
  document.getElementById('exportProgress').addEventListener('click', ()=>{
    const blob = new Blob([localStorage.getItem(SRS_KEY) || '[]'], {type: 'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'progression-ivre-baudelaire.json';
    a.click();
  });
  document.getElementById('resetProgress').addEventListener('click', ()=>{
    if(confirm('Réinitialiser toute la progression SRS ?')){
      localStorage.removeItem(SRS_KEY); SRS = loadSRS(); renderSRS();
    }
  });

  // —————————————————————————————————————————————
  // Mini‑rituel PNL : respiration + visualisation
  // —————————————————————————————————————————————
  (function breathGuide(){
    let phase = 0; // 0 inspire, 1 retien, 2 expire
    const phases = ['Inspire (4)', 'Retiens (4)', 'Expire (6)'];
    let count = 0; let target = [4,4,6][phase];
    const header = document.querySelector('header h1');
    setInterval(()=>{
      count++; if(count>=target){ phase=(phase+1)%3; target=[4,4,6][phase]; count=0; }
      header.dataset.breath = phases[phase];
      header.title = 'Rituel respiration : ' + phases[phase];
    }, 1000);
  })();

  </script>
</body>
</html>
